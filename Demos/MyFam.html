<!DOCTYPE html>
<html>
<head>
    <title>OneDrive Shared Items Viewer</title>
    <script src="https://alcdn.msauth.net/browser/2.30.0/js/msal-browser.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .person-section { margin: 20px 0; padding: 10px; border: 1px solid #ddd; }
        .type-section { margin: 10px 0; padding: 10px; background: #f5f5f5; }
        .item { margin: 5px 0; padding: 5px; display: flex; align-items: center; }
        .thumbnail { width: 64px; height: 64px; object-fit: cover; margin-right: 12px; border-radius: 4px; border: 1px solid #ccc; }
        #loginButton { padding: 10px; font-size: 16px; cursor: pointer; }
        .details { font-size: 12px; color: #555; margin-left: 8px; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <button id="loginButton">Sign in with Microsoft</button>
    <div id="content" class="hidden">
        <h1>Shared Items</h1>
        <div id="itemsContainer"></div>
    </div>

    <script>
        const msalConfig = {
            auth: {
                clientId: "9ba40cef-cb84-4bdd-b277-42c861dec363",
                authority: "https://login.microsoftonline.com/common",
                redirectUri: window.location.origin,
            },
            cache: {
                cacheLocation: "sessionStorage",
                storeAuthStateInCookie: false
            }
        };

        const GRAPH_SCOPES = ["Files.Read.All", "Files.Read.Shared"];
        const msalInstance = new msal.PublicClientApplication(msalConfig);
        const loginButton = document.getElementById('loginButton');
        const content = document.getElementById('content');
        const itemsContainer = document.getElementById('itemsContainer');

        // Helper: get access token for Graph
        async function getToken() {
            const accounts = msalInstance.getAllAccounts();
            if (accounts.length === 0) throw new Error("No signed-in account");
            try {
                const silentResult = await msalInstance.acquireTokenSilent({
                    account: accounts[0],
                    scopes: GRAPH_SCOPES
                });
                return silentResult.accessToken;
            } catch (e) {
                // fallback to popup if silent fails
                const popupResult = await msalInstance.acquireTokenPopup({
                    scopes: GRAPH_SCOPES
                });
                return popupResult.accessToken;
            }
        }

        // Login click handler
        loginButton.addEventListener('click', async () => {
            try {
                await msalInstance.loginPopup({ scopes: GRAPH_SCOPES });
                // Now get token and fetch shared items
                const accessToken = await getToken();
                await getSharedItems(accessToken);
            } catch (error) {
                console.error(error);
                alert("Login failed: " + error.message);
            }
        });

        // Get shared items from Microsoft Graph API
        async function getSharedItems(accessToken) {
            try {
                const response = await fetch('https://graph.microsoft.com/v1.0/me/drive/sharedWithMe', {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                const data = await response.json();
                if (!Array.isArray(data.value)) throw new Error("Unexpected Graph API response");
                loginButton.classList.add('hidden');
                content.classList.remove('hidden');
                organizeAndDisplayItems(data.value, accessToken);
            } catch (error) {
                console.error('Error fetching shared items:', error);
                alert('Error fetching shared items: ' + error.message);
            }
        }

        // Helper: is image file
        function isPicture(item) {
            const imageExtensions = ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'tiff', 'webp'];
            if (item.file && item.name) {
                const ext = item.name.split('.').pop().toLowerCase();
                return imageExtensions.includes(ext);
            }
            return false;
        }

        // Helper: format date string
        function formatDate(dateString) {
            if (!dateString) return '';
            const d = new Date(dateString);
            return d.toLocaleString();
        }

        // Helper: get thumbnail url for a file item
        function getThumbnail(item) {
            // Graph API provides thumbnails at item.remoteItem.thumbnails[0].medium.url if available
            // Sometimes it's item.thumbnails, or you need to fetch /thumbnails endpoint; here, try direct
            let thumb = null;
            if (item.remoteItem?.thumbnails?.length > 0) {
                thumb = item.remoteItem.thumbnails[0].medium?.url || item.remoteItem.thumbnails[0].small?.url;
            } else if (item.thumbnails?.length > 0) {
                thumb = item.thumbnails[0].medium?.url || item.thumbnails[0].small?.url;
            }
            return thumb;
        }

        // Organize and display items
        function organizeAndDisplayItems(items, accessToken) {
            // Group items by person (owner)
            const itemsByPerson = {};
            items.forEach(item => {
                const owner = item.remoteItem?.shared?.owner?.user?.displayName || 'Unknown';
                if (!itemsByPerson[owner]) {
                    itemsByPerson[owner] = [];
                }
                itemsByPerson[owner].push(item);
            });

            // Clear container
            itemsContainer.innerHTML = '';

            // Create sections for each person
            for (const person in itemsByPerson) {
                const personSection = document.createElement('div');
                personSection.className = 'person-section';
                personSection.innerHTML = `<h2>${person}</h2>`;

                // Group items into "Pictures" and "Other"
                const pictures = [];
                const others = {};

                itemsByPerson[person].forEach(item => {
                    if (isPicture(item)) {
                        pictures.push(item);
                    } else {
                        let type = 'Other';
                        if (item.folder) type = 'Folder';
                        else if (item.file) type = 'File';
                        else if (item.package?.type === 'oneNote') type = 'OneNote';
                        if (!others[type]) {
                            others[type] = [];
                        }
                        others[type].push(item);
                    }
                });

                // Pictures section
                if (pictures.length > 0) {
                    const picSection = document.createElement('div');
                    picSection.className = 'type-section';
                    picSection.innerHTML = `<h3>Pictures</h3>`;
                    pictures.forEach(item => {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'item';

                        // Thumbnail preview
                        const thumbUrl = getThumbnail(item);
                        if (thumbUrl) {
                            const img = document.createElement('img');
                            img.className = 'thumbnail';
                            img.src = thumbUrl + (thumbUrl.includes('?') ? '&' : '?') + 'access_token=' + encodeURIComponent(accessToken);
                            img.alt = 'Thumbnail';
                            itemDiv.appendChild(img);
                        }

                        // File link and details
                        const itemLink = document.createElement('a');
                        itemLink.href = item.webUrl;
                        itemLink.target = '_blank';
                        itemLink.textContent = item.name;
                        itemDiv.appendChild(itemLink);

                        const details = document.createElement('span');
                        details.className = 'details';
                        details.textContent = `Shared: ${formatDate(item.sharedDateTime || item.remoteItem?.shared?.sharedDateTime)}`;
                        itemDiv.appendChild(details);

                        picSection.appendChild(itemDiv);
                    });
                    personSection.appendChild(picSection);
                }

                // Other types section
                for (const type in others) {
                    const typeSection = document.createElement('div');
                    typeSection.className = 'type-section';
                    typeSection.innerHTML = `<h3>${type}</h3>`;
                    others[type].forEach(item => {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'item';

                        // File/folder link
                        const itemLink = document.createElement('a');
                        itemLink.href = item.webUrl;
                        itemLink.target = '_blank';
                        itemLink.textContent = item.name;
                        itemDiv.appendChild(itemLink);

                        const details = document.createElement('span');
                        details.className = 'details';
                        details.textContent = `Shared: ${formatDate(item.sharedDateTime || item.remoteItem?.shared?.sharedDateTime)}`;
                        itemDiv.appendChild(details);

                        typeSection.appendChild(itemDiv);
                    });
                    personSection.appendChild(typeSection);
                }

                itemsContainer.appendChild(personSection);
            }
        }
    </script>
</body>
</html>