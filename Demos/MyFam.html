
<!DOCTYPE html>
<html>
<head>
    <title>OneDrive Shared Items Viewer</title>
    <script src="https://alcdn.msauth.net/browser/2.30.0/js/msal-browser.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .person-section { margin: 20px 0; padding: 10px; border: 1px solid #ddd; }
        .type-section { margin: 10px 0; padding: 10px; background: #f5f5f5; }
        .item { margin: 5px 0; padding: 5px; }
        #loginButton { padding: 10px; font-size: 16px; cursor: pointer; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <button id="loginButton">Sign in with Microsoft</button>
    <div id="content" class="hidden">
        <h1>Shared Items</h1>
        <div id="itemsContainer"></div>
    </div>

    <script>
        const msalConfig = {
            auth: {
                clientId: "9ba40cef-cb84-4bdd-b277-42c861dec363", // Replace with your Azure AD app registration client ID
                authority: "https://login.microsoftonline.com/common",
                redirectUri: window.location.origin,
            },
            cache: {
                cacheLocation: "sessionStorage",
                storeAuthStateInCookie: false
            }
        };

        const msalInstance = new msal.PublicClientApplication(msalConfig);
        const loginButton = document.getElementById('loginButton');
        const content = document.getElementById('content');
        const itemsContainer = document.getElementById('itemsContainer');

        // Login click handler
        loginButton.addEventListener('click', async () => {
            try {
                const loginResponse = await msalInstance.loginPopup({
                    scopes: ["Files.Read.All", "Files.Read.Shared"]
                });
                getSharedItems(loginResponse.accessToken);
            } catch (error) {
                console.error(error);
            }
        });

        // Get shared items from Microsoft Graph API
        async function getSharedItems(accessToken) {
            try {
                const response = await fetch('https://graph.microsoft.com/v1.0/me/drive/sharedWithMe', {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
                const data = await response.json();
                organizeAndDisplayItems(data.value);
                loginButton.classList.add('hidden');
                content.classList.remove('hidden');
            } catch (error) {
                console.error('Error fetching shared items:', error);
            }
        }

        // Organize and display items
        function organizeAndDisplayItems(items) {
            // Group items by person (owner)
            const itemsByPerson = {};
            items.forEach(item => {
                const owner = item.remoteItem?.shared?.owner?.user?.displayName || 'Unknown';
                if (!itemsByPerson[owner]) {
                    itemsByPerson[owner] = [];
                }
                itemsByPerson[owner].push(item);
            });

            // Clear container
            itemsContainer.innerHTML = '';

            // Create sections for each person
            for (const person in itemsByPerson) {
                const personSection = document.createElement('div');
                personSection.className = 'person-section';
                personSection.innerHTML = `<h2>${person}</h2>`;

                // Group items by type
                const itemsByType = {};
                itemsByPerson[person].forEach(item => {
                    let type = 'Other';
                    if (item.folder) type = 'Folder';
                    else if (item.file) type = 'File';
                    else if (item.package?.type === 'oneNote') type = 'OneNote';

                    if (!itemsByType[type]) {
                        itemsByType[type] = [];
                    }
                    itemsByType[type].push(item);
                });

                // Create sections for each type
                for (const type in itemsByType) {
                    const typeSection = document.createElement('div');
                    typeSection.className = 'type-section';
                    typeSection.innerHTML = `<h3>${type}</h3>`;

                    // Add items
                    itemsByType[type].forEach(item => {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'item';
                        const itemLink = document.createElement('a');
                        itemLink.href = item.webUrl;
                        itemLink.target = '_blank';
                        itemLink.textContent = item.name;
                        itemDiv.appendChild(itemLink);
                        typeSection.appendChild(itemDiv);
                    });

                    personSection.appendChild(typeSection);
                }

                itemsContainer.appendChild(personSection);
            }
        }
    </script>
</body>
</html>