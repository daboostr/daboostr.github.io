<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>WebLLM Demo</title>
  <style>
    :root {
      --bg: #ffffff;
      --fg: #0f172a;
      --muted: #64748b;
      --border: #e2e8f0;
      --accent: #2563eb;
      --good: #059669;
      --bad: #dc2626;
      --warn: #d97706;
      --panel: #f8fafc;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--fg);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    }
    header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }
    .env {
      color: var(--muted);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 13px;
    }
    .container {
      padding: 20px;
    }
    .layout {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 16px;
      min-height: calc(100vh - 80px);
    }
    @media (max-width: 900px) {
      .layout { grid-template-columns: 1fr; }
    }
    .card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 16px;
    }
    h1 {
      margin: 0;
      font-size: 20px;
    }
    .row {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }
    label { font-weight: 600; }
    select, textarea, input[type="text"] {
      width: 100%;
      max-width: 900px;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: #fff;
      font: inherit;
    }
    textarea {
      min-height: 140px;
      resize: vertical;
    }
    button {
      padding: 10px 14px;
      border: 1px solid var(--border);
      background: #fff;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
    }
    button.primary {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .status {
      min-height: 1.2em;
      color: var(--muted);
    }
    .status.good { color: var(--good); }
    .status.bad { color: var(--bad); }
    .status.warn { color: var(--warn); }

    .progress {
      height: 8px;
      background: #e5e7eb;
      border-radius: 999px;
      overflow: hidden;
      width: 100%;
    }
    .progress > .bar {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #60a5fa, #2563eb);
      transition: width 120ms ease;
    }

    .console {
      display: flex;
      flex-direction: column;
      min-height: 40vh;
    }
    .console-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    .console-view {
      background: #0b1220;
      color: #e5e7eb;
      border: 1px solid #1f2937;
      border-radius: 8px;
      padding: 10px;
      height: 100%;
      min-height: 360px;
      overflow: auto;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      line-height: 1.35;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .log-line { opacity: 0.95; }
    .log-time { color: #9ca3af; }
    .log-info { color: #c7d2fe; }
    .log-warn { color: #fde68a; }
    .log-error { color: #fecaca; }
    .muted { color: var(--muted); }
    .hint { font-size: 13px; color: var(--muted); }
  </style>
</head>
<body>
  <header>
    <h1>WebLLM In-Browser Demo</h1>
    <div id="env" class="env">Detecting environment…</div>
  </header>

  <div class="container">
    <div class="layout">
      <!-- Main app (2/3) -->
      <section class="card">
        <div class="row">
          <label for="model">Model</label>
          <select id="model">
            <option value="Qwen2.5-0.5B-Instruct-q4f32_1-MLC" selected>Qwen2.5-0.5B-Instruct (q4f32_1)</option>
            <option value="Phi-3-mini-4k-instruct-q4f16_1-MLC">Phi-3-mini-4k-instruct (q4f16_1)</option>
          </select>
          <button id="reinit">Reinitialize</button>
        </div>

        <div class="row">
          <div class="progress" aria-label="Initialization progress">
            <div id="progressBar" class="bar"></div>
          </div>
        </div>

        <div id="status" class="status">Initializing LLM…</div>

        <div class="hint" style="margin: 8px 0 16px;">
          First-time load downloads model weights (cached by your browser for future use).
        </div>

        <div class="row" style="flex-direction:column; align-items:stretch;">
          <label for="input">Prompt</label>
          <textarea id="input" placeholder="Type your prompt here…" disabled></textarea>
        </div>

        <div class="row">
          <button id="run" class="primary" disabled>Run</button>
          <button id="stop" disabled>Stop</button>
          <span id="runStatus" class="status"></span>
        </div>

        <div class="row" style="flex-direction:column; align-items:stretch; margin-top: 8px;">
          <label>Output</label>
          <div id="output" class="card" style="background:#fff; min-height:120px;"></div>
        </div>
      </section>

      <!-- Console (1/3) -->
      <aside class="console">
        <div class="console-header">
          <strong>Console</strong>
          <div>
            <button id="copyLogs">Copy</button>
            <button id="clearLogs">Clear</button>
          </div>
        </div>
        <div id="console" class="console-view" aria-live="polite"></div>
        <div class="hint" style="margin-top: 8px;">
          This console mirrors important steps, progress, warnings, and errors.
        </div>
      </aside>
    </div>
  </div>

  <script>
    // --- Utilities & UI helpers ------------------------------------------------
    const $ = (id) => document.getElementById(id);
    const envEl = $('env');
    const statusEl = $('status');
    const runStatusEl = $('runStatus');
    const progressBar = $('progressBar');
    const consoleEl = $('console');
    const outputEl = $('output');
    const inputEl = $('input');
    const runBtn = $('run');
    const stopBtn = $('stop');
    const reinitBtn = $('reinit');
    const modelSel = $('model');

    function nowTime() {
      const d = new Date();
      return d.toLocaleTimeString([], { hour12: false });
    }

    function uiLog(level, msg, obj) {
      const line = document.createElement('div');
      line.className = `log-line log-${level}`;
      const t = document.createElement('span');
      t.className = 'log-time';
      t.textContent = `[${nowTime()}] `;
      const m = document.createElement('span');
      m.className = `log-${level}`;
      m.textContent = typeof msg === 'string' ? msg : JSON.stringify(msg);
      line.appendChild(t);
      line.appendChild(m);

      if (obj !== undefined) {
        const d = document.createElement('div');
        d.style.marginLeft = '10px';
        d.className = 'muted';
        try {
          d.textContent = typeof obj === 'string' ? obj : JSON.stringify(obj);
        } catch {
          d.textContent = String(obj);
        }
        line.appendChild(d);
      }

      consoleEl.appendChild(line);
      consoleEl.scrollTop = consoleEl.scrollHeight;
    }

    // Mirror console to UI (non-invasive)
    ['log','info','warn','error'].forEach((method) => {
      const orig = console[method].bind(console);
      console[method] = (...args) => {
        try {
          uiLog(method === 'log' ? 'info' : method, args[0], args[1]);
        } catch {}
        orig(...args);
      };
    });

    function setEnvInfo() {
      const env = {
        secure: !!window.isSecureContext,
        coi: !!window.crossOriginIsolated,
        webgpu: 'gpu' in navigator,
        ua: navigator.userAgent
      };
      envEl.textContent = `Env — secure:${env.secure} coi:${env.coi} webgpu:${env.webgpu}`;
      uiLog('info', 'Environment', env);
      if (!env.webgpu) {
        uiLog('warn', 'WebGPU not detected; please use Chrome/Edge desktop v121+ and ensure WebGPU is enabled.');
      }
    }

    function setStatus(text, type) {
      statusEl.classList.remove('good','bad','warn');
      if (type) statusEl.classList.add(type);
      statusEl.textContent = text || '';
    }

    function setRunStatus(text, type) {
      runStatusEl.classList.remove('good','bad','warn');
      if (type) runStatusEl.classList.add(type);
      runStatusEl.textContent = text || '';
    }

    function setProgress(pct01, text) {
      const pct = Math.max(0, Math.min(1, pct01 || 0));
      progressBar.style.width = `${Math.round(pct * 100)}%`;
      if (text) setStatus(text);
    }

    function enableInput(enabled) {
      inputEl.disabled = !enabled;
      runBtn.disabled = !enabled;
      stopBtn.disabled = !enabled;
    }

    // --- Load vendored WebLLM UMD ------------------------------------------------
    function loadScript(src, attrs = {}) {
      return new Promise((resolve, reject) => {
        const s = document.createElement('script');
        Object.assign(s, attrs);
        s.src = src;
        s.async = true;
        s.onload = () => resolve();
        s.onerror = (e) => reject(e);
        document.head.appendChild(s);
      });
    }

    async function loadWebLLM() {
      if (window.webllm) return window.webllm;
      setStatus('Loading WebLLM library…');
      uiLog('info', 'Step: Load WebLLM UMD from /assets/webllm/index.min.js');
      await loadScript('/assets/webllm/index.min.js');
      // Normalize potential global names
      window.webllm = window.webllm || window.WebLLM || window.mlc || window.MLC;
      if (!window.webllm) {
        throw new Error('WebLLM UMD loaded but no global found (expected window.webllm or window.WebLLM).');
      }
      uiLog('info', 'WebLLM library loaded.');
      return window.webllm;
    }

    // --- Engine init (force main thread; GitHub Pages lacks COOP/COEP) ----------
    async function createEngineNoWorker(webllmObj, modelId, baseOpts) {
      const attempts = [
        { useWebWorker: false },
        { worker: false },
        { use_web_worker: false },
      ];
      let lastErr = null;
      for (const extra of attempts) {
        try {
          uiLog('info', 'CreateMLCEngine attempt', extra);
          const eng = await webllmObj.CreateMLCEngine(modelId, { ...baseOpts, ...extra });
          return eng;
        } catch (e) {
          lastErr = e;
          console.warn('CreateMLCEngine failed with options', extra, e);
        }
      }
      if (lastErr) throw lastErr;
      throw new Error('Failed to create engine (no error detail).');
    }

    // --- App logic ---------------------------------------------------------------
    let engine = null;
    let currentModel = null;
    let generating = false;
    let abortController = null;

    async function initialize(modelId) {
      try {
        enableInput(false);
        setProgress(0, 'Initializing LLM…');
        setRunStatus('');

        const webllm = await loadWebLLM();

        setStatus('Preparing engine…');
        const baseOpts = {
          logLevel: 'info',
          initProgressCallback: (progress) => {
            try {
              const p = progress?.progress;
              const text = progress?.text || 'Loading';
              const pct = typeof p === 'number' ? p : 0;
              setProgress(pct, `${text} (${Math.round(pct * 100)}%)`);
              uiLog('info', 'Init progress', progress);
            } catch {}
          },
        };

        engine = await createEngineNoWorker(webllm, modelId, baseOpts);
        currentModel = modelId;
        setProgress(1, 'Model ready.');
        setStatus('Model initialized successfully. Ready.', 'good');
        uiLog('info', 'Engine ready for model ' + modelId);
        enableInput(true);
        inputEl.focus();
      } catch (e) {
        engine = null;
        currentModel = null;
        setStatus('Initialization failed. See console for details.', 'bad');
        uiLog('error', 'Initialization error', e && (e.message || String(e)));
      }
    }

    async function runPrompt() {
      const prompt = (inputEl.value || '').trim();
      if (!prompt) { inputEl.focus(); return; }
      if (!engine) { setRunStatus('Engine not ready.', 'bad'); return; }
      if (generating) return;

      generating = true;
      runBtn.disabled = true;
      stopBtn.disabled = false;
      setRunStatus('Generating…');
      outputEl.textContent = '';

      try {
        abortController = new AbortController();
        const reply = await engine.chat.completions.create({
          messages: [{ role: 'user', content: prompt }],
          temperature: 0.7,
          max_tokens: 512,
          // signal: abortController.signal, // Only if supported by version
        });
        const text =
          reply?.choices?.[0]?.message?.content ??
          reply?.output_text ?? reply?.text ?? reply?.choices?.[0]?.text ?? '';
        outputEl.textContent = text || '(No text returned)';
        setRunStatus('Done.', 'good');
        uiLog('info', 'Generation completed.');
      } catch (e) {
        const msg = e && e.message ? e.message : String(e);
        setRunStatus('Error: ' + msg, 'bad');
        uiLog('error', 'Generation error', msg);
      } finally {
        generating = false;
        runBtn.disabled = false;
        stopBtn.disabled = true;
        abortController = null;
      }
    }

    function stopGeneration() {
      try {
        if (abortController) {
          abortController.abort();
          uiLog('warn', 'Generation aborted.');
        }
      } catch {}
    }

    // --- Wire up UI -------------------------------------------------------------
    (function main() {
      setEnvInfo();

      $('clearLogs').addEventListener('click', () => {
        consoleEl.textContent = '';
      });
      $('copyLogs').addEventListener('click', async () => {
        const text = consoleEl.innerText || '';
        try {
          await navigator.clipboard.writeText(text);
          uiLog('info', 'Console copied to clipboard.');
        } catch {
          uiLog('warn', 'Failed to copy console to clipboard.');
        }
      });

      runBtn.addEventListener('click', runPrompt);
      stopBtn.addEventListener('click', stopGeneration);
      inputEl.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') runPrompt();
      });
      reinitBtn.addEventListener('click', () => {
        uiLog('info', 'Reinitialize requested.');
        initialize(modelSel.value);
      });

      // Auto-initialize on load
      initialize(modelSel.value);
    })();
  </script>
</body>
</html>
